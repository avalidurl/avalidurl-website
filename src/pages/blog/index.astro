---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';

// Helper function to parse dates consistently in Istanbul timezone
const parseIstanbulDate = (dateString) => {
  // Handle non-string values
  if (typeof dateString !== 'string') {
    return new Date(dateString);
  }
  // If it's just a date (YYYY-MM-DD), append Istanbul timezone
  if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
    return new Date(dateString + 'T00:00:00+03:00');
  }
  // For datetime strings, parse as-is but assume they're in Istanbul time
  return new Date(dateString);
};

const allBlogPosts = await getCollection('blog', ({ data }) => {
  // Don't show draft posts
  if (data.draft) return false;
  
  // Allow posts with dates up to 1 day in the future (for timezone issues)
  const publishDate = parseIstanbulDate(data.publishDate);
  const now = new Date();
  const oneDayFromNow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
  
  // Only filter out posts that are more than 1 day in the future
  return publishDate <= oneDayFromNow;
});

// Sort by publish date (newest first) using Istanbul timezone parsing
const sortedPosts = allBlogPosts.sort((a, b) => 
  parseIstanbulDate(b.data.publishDate).getTime() - parseIstanbulDate(a.data.publishDate).getTime()
);

// Show all posts in chronological order (newest first)
const allPosts = sortedPosts;
---

<Layout title="Blog - Thoughts on Finance, Art & Code" description="Exploring the intersection of financial markets, creative coding, and artistic expression through data-driven insights and technical analysis.">
  <main class="container">
    <header class="blog-header">
      <h1>Journal</h1>
      <p class="blog-subtitle">
        Thoughts on the intersection of finance, art, and code â€” where data meets creativity and markets become canvases.
      </p>
    </header>

    <section class="all-posts-section">
      <h2>All Posts</h2>
      <div class="articles-grid">
        {allPosts.map(post => (
          <article class="article-card">
            <div class="article-meta">
              <span class="article-category">{post.data.category}</span>
              <time class="article-date">
                {parseIstanbulDate(post.data.publishDate).toLocaleDateString('en-US', {
                  month: 'short',
                  day: 'numeric',
                  year: 'numeric',
                  timeZone: 'Europe/Istanbul'
                })}
              </time>
            </div>
            <h3 class="article-title">
              <a href={`/blog/${post.slug}`}>
                {post.data.title}
              </a>
            </h3>
            <p class="article-excerpt">
              {post.data.excerpt || post.data.description}
            </p>
            {post.data.readingTime && (
              <span class="reading-time">{post.data.readingTime} min read</span>
            )}
          </article>
        ))}
      </div>
    </section>

    <aside class="blog-sidebar">
      <div class="newsletter-signup">
        <h3>Stay Updated</h3>
        <p>Get notified of new posts exploring finance, art, and technology.</p>
        <form class="newsletter-form" action="https://app.kit.com/forms/8250157/subscriptions" method="post" data-sv-form="8250157" data-uid="6c28efde16" data-format="inline" data-version="5">
          <input 
            type="email" 
            name="email_address" 
            placeholder="your@email.com" 
            required
          >
          <button type="submit">Subscribe</button>
        </form>
        <p class="newsletter-note">
          Or follow via <a href="/feed.xml" class="rss-link">RSS Feed</a>
        </p>
      </div>
    </aside>
  </main>
</Layout>